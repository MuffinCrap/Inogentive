# Environment Setup Guide: Weekly Compliance Report Automation

## Overview
This guide walks you through setting up the n8n automation platform and configuring the Weekly Compliance Report workflow for Cards Direct.

## Prerequisites

### System Requirements
- **OS**: Linux (Ubuntu 20.04+) or Docker-compatible environment
- **Memory**: Minimum 2GB RAM, Recommended 4GB+
- **Storage**: 10GB available space
- **Network**: Stable internet connection for API calls

### Required Accounts & Credentials
1. **Azure Account** with permissions for:
   - Azure AD App Registration
   - Power BI workspace access
   - Azure Blob Storage

2. **Microsoft Fabric/Power BI**:
   - Workspace ID
   - Dataset ID
   - API access enabled

3. **OpenAI Account**:
   - API key with GPT-4o access
   - Sufficient credits/quota

4. **Email Service**:
   - SMTP credentials OR Microsoft Graph API access

## Step 1: Install n8n

### Option A: Docker Installation (Recommended)

```bash
# Pull the n8n Docker image
docker pull n8nio/n8n

# Create a data directory for persistence
mkdir -p ~/n8n-data

# Run n8n with Docker
docker run -d \
  --name n8n \
  -p 5678:5678 \
  -e N8N_BASIC_AUTH_ACTIVE=true \
  -e N8N_BASIC_AUTH_USER=admin \
  -e N8N_BASIC_AUTH_PASSWORD='your-secure-password' \
  -e GENERIC_TIMEZONE='Europe/London' \
  -e TZ='Europe/London' \
  -v ~/n8n-data:/home/node/.n8n \
  n8nio/n8n
```

### Option B: npm Installation

```bash
# Install n8n globally
npm install n8n -g

# Start n8n
n8n start
```

### Option C: Azure Container Instance

```bash
# Create Azure Container Instance
az container create \
  --resource-group n8n-rg \
  --name n8n-automation \
  --image n8nio/n8n \
  --dns-name-label n8n-cardsdirect \
  --ports 5678 \
  --cpu 2 \
  --memory 4 \
  --environment-variables \
    N8N_BASIC_AUTH_ACTIVE=true \
    N8N_BASIC_AUTH_USER=admin \
    N8N_BASIC_AUTH_PASSWORD='your-secure-password' \
    GENERIC_TIMEZONE='Europe/London' \
    TZ='Europe/London'
```

## Step 2: Configure PostgreSQL Database

n8n requires PostgreSQL for production deployments to store workflow data and execution history.

### Install PostgreSQL

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install postgresql postgresql-contrib

# Start PostgreSQL service
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### Create Database and User

```bash
# Switch to postgres user
sudo -u postgres psql

# Create database and user
CREATE DATABASE n8n;
CREATE USER n8n_user WITH PASSWORD 'your-secure-db-password';
GRANT ALL PRIVILEGES ON DATABASE n8n TO n8n_user;
\q
```

### Configure n8n to use PostgreSQL

Add these environment variables:

```bash
export DB_TYPE=postgresdb
export DB_POSTGRESDB_HOST=localhost
export DB_POSTGRESDB_PORT=5432
export DB_POSTGRESDB_DATABASE=n8n
export DB_POSTGRESDB_USER=n8n_user
export DB_POSTGRESDB_PASSWORD='your-secure-db-password'
```

## Step 3: Set Up Environment Variables

Create a `.env` file in your n8n data directory:

```bash
# n8n Configuration
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=your-secure-password
GENERIC_TIMEZONE=Europe/London
TZ=Europe/London
N8N_HOST=https://n8n.yourdomain.com
WEBHOOK_URL=https://n8n.yourdomain.com/

# Database Configuration
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=localhost
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=n8n
DB_POSTGRESDB_USER=n8n_user
DB_POSTGRESDB_PASSWORD=your-secure-db-password

# Azure/Power BI Configuration
POWERBI_TENANT_ID=73890052-7df3-4774-bed7-b43d5ebd83db
POWERBI_CLIENT_ID=6492b933-768a-47a6-a808-5b47192f672e
POWERBI_CLIENT_SECRET=YOb8Q~.M6rf-dNuX_3tTMmQPOnMCEr58vWExOddf
POWERBI_WORKSPACE_ID=99355c3e-0913-4d08-a77c-2934cf1c94fb
POWERBI_DATASET_ID=80c0dd7c-ba46-4543-be77-faf57e0b806a

# OpenAI Configuration
OPENAI_API_KEY=sk-proj-your-api-key-here

# Azure Blob Storage (for archiving)
AZURE_STORAGE_ACCOUNT=your-storage-account-name
AZURE_STORAGE_SAS_TOKEN=your-sas-token-here

# Email Configuration
EMAIL_FROM=automation@cardsdirect.co.uk
EMAIL_SMTP_HOST=smtp.office365.com
EMAIL_SMTP_PORT=587
EMAIL_SMTP_USER=automation@cardsdirect.co.uk
EMAIL_SMTP_PASSWORD=your-email-password
```

## Step 4: Configure n8n Credentials

After starting n8n, access the web interface at `http://localhost:5678` and configure the following credentials:

### 1. Bearer Token API (for Power BI)
- **Name**: Bearer Token
- **Type**: Bearer Token
- **Token**: Will be dynamically generated by OAuth node

### 2. OpenAI API
- **Name**: OpenAI API
- **Type**: OpenAI
- **API Key**: Your OpenAI API key from environment variable

### 3. SMTP Email (if using SMTP)
- **Name**: Cards Direct Email
- **Type**: SMTP
- **Host**: smtp.office365.com
- **Port**: 587
- **User**: automation@cardsdirect.co.uk
- **Password**: Your email password
- **From Email**: automation@cardsdirect.co.uk

## Step 5: Install Required npm Packages

For PDF generation, n8n needs the PDFKit library:

```bash
# If using Docker, exec into container
docker exec -it n8n /bin/sh

# Install PDFKit
cd /usr/local/lib/node_modules/n8n
npm install pdfkit

# Exit container
exit
```

For standalone installation:

```bash
# Navigate to n8n installation
cd $(npm root -g)/n8n

# Install PDFKit
npm install pdfkit
```

## Step 6: Import Workflow

1. Open n8n web interface: `http://localhost:5678`
2. Click **"Workflows"** in the left menu
3. Click **"Import from File"**
4. Select `weekly-compliance-report.json`
5. Click **"Import"**

## Step 7: Configure Workflow Variables

Open the imported workflow and update the **"Set Workflow Variables"** node with your specific configuration:

```javascript
const config = {
  // Update these values for your environment
  recipients: ['matt@cardsdirect.co.uk', 'chirag@cardsdirect.co.uk'],
  ccRecipients: ['executives@cardsdirect.co.uk'],

  // Adjust thresholds as needed
  thresholds: {
    hoursVariancePercent: 5,
    manualClockInPercent: 10,
    cashDiscrepancyAmount: 50,
    refundPercent: 3,
    stockAdjustmentPercent: 2
  }
};
```

## Step 8: Test the Workflow

### Manual Test Execution

1. Click the workflow name to open it
2. Click **"Execute Workflow"** button in top right
3. Select **"Run Workflow"** â†’ **"Manual"**
4. Monitor execution in the bottom panel
5. Check each node for successful execution

### Dry Run Test

For initial testing without sending emails or archiving:

1. Disable the **"Send Compliance Report Email"** node
2. Disable the **"Archive to Azure Blob"** node
3. Add a **"Stop and Error"** node after PDF generation to inspect output
4. Execute manually and review PDF data

### Test Individual Nodes

Test critical nodes independently:

```bash
# Test OAuth Token
curl -X POST https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials&client_id={CLIENT_ID}&client_secret={CLIENT_SECRET}&scope=https://api.fabric.microsoft.com/.default"

# Test Power BI Dataset Access
curl -X GET "https://api.powerbi.com/v1.0/myorg/groups/{WORKSPACE_ID}/datasets" \
  -H "Authorization: Bearer {ACCESS_TOKEN}"
```

## Step 9: Enable Scheduled Execution

Once testing is complete:

1. Open the workflow
2. Click the **"Schedule - Every Monday 9AM"** trigger node
3. Verify the cron expression: `0 9 * * 1`
4. Click **"Activate"** toggle in top right
5. Workflow will now run automatically every Monday at 9 AM

## Step 10: Set Up Monitoring

### Enable Workflow Execution History

```bash
# Set environment variable
export EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
export EXECUTIONS_DATA_SAVE_ON_ERROR=all
export EXECUTIONS_DATA_MAX_AGE=168  # Keep 7 days
```

### Configure Alerts

The workflow includes error handling that sends alerts to `it-alerts@cardsdirect.co.uk`. Ensure this email is monitored.

### Log Monitoring

```bash
# View n8n logs (Docker)
docker logs -f n8n

# View PostgreSQL execution history
psql -U n8n_user -d n8n -c "SELECT * FROM execution_entity ORDER BY startedAt DESC LIMIT 10;"
```

## Troubleshooting

### Common Issues

#### 1. OAuth Token Failure
**Error**: "Failed to obtain valid OAuth token"

**Solution**:
- Verify tenant ID, client ID, and client secret
- Check Azure AD app permissions include `https://api.fabric.microsoft.com/.default`
- Ensure app has granted admin consent

#### 2. Power BI API Access Denied
**Error**: "Power BI query failed: 403 Forbidden"

**Solution**:
- Verify service principal has access to Power BI workspace
- Enable "Service principals can use Power BI APIs" in Power BI admin settings
- Add service principal to workspace with Member or Admin role

#### 3. OpenAI API Rate Limits
**Error**: "Rate limit exceeded"

**Solution**:
- Upgrade OpenAI account tier
- Add retry logic with exponential backoff
- Reduce temperature or max_tokens to use fewer tokens

#### 4. Email Send Failure
**Error**: "Failed to send email"

**Solution**:
- Verify SMTP credentials and server settings
- Check firewall allows outbound connections on port 587
- Ensure sender email has permission to send as automation account

#### 5. PDF Generation Issues
**Error**: "PDFKit is not defined"

**Solution**:
- Install PDFKit: `npm install pdfkit` in n8n directory
- Restart n8n service
- Verify library is loaded in Code node

### Performance Optimization

#### Reduce Execution Time

1. **Parallel DAX Queries**: Already configured to run in parallel
2. **Optimize DAX**: Ensure measures are pre-aggregated in Power BI
3. **Cache Tokens**: OAuth tokens valid for 60 minutes, cache if running frequently
4. **Reduce OpenAI Tokens**: Adjust max_tokens from 2000 to 1500 if narrative too long

#### Memory Management

```bash
# Increase Node.js memory limit for n8n
export NODE_OPTIONS="--max-old-space-size=4096"
```

## Security Best Practices

1. **Credential Storage**: Use n8n's credential encryption, never hardcode secrets
2. **API Key Rotation**: Rotate Azure and OpenAI keys quarterly
3. **Access Control**: Limit n8n web interface access via firewall/VPN
4. **HTTPS**: Always use HTTPS for n8n in production
5. **Audit Logs**: Enable PostgreSQL logging for compliance
6. **Backup**: Regular backups of n8n database and workflows

## Next Steps

- Review **DEPLOYMENT.md** for Azure production deployment
- Review **TESTING.md** for comprehensive test scenarios
- Configure monitoring and alerting
- Schedule user training sessions

## Support

For issues or questions:
- Email: it-support@cardsdirect.co.uk
- Documentation: https://docs.n8n.io
- Power BI API: https://learn.microsoft.com/en-us/rest/api/power-bi/
