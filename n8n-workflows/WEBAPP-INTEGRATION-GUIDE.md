# Web App Integration Guide
## n8n Workflow â†’ Backend PDF Generation â†’ Web UI

**Status:** Ready for Testing
**Date:** 2025-11-23
**Components:** n8n Workflow | Node.js Backend | Web App

---

## âœ… Completed Setup

### 1. Backend Server (RUNNING âœ“)
- **URL:** http://localhost:3001
- **PDF Endpoint:** POST `/api/generate-pdf`
- **Health Check:** GET `/api/health`
- **PDFKit installed and configured**

### 2. Web App (UPDATED âœ“)
- **Location:** `/web-ui/`
- **Updated:** `app.js` with n8n webhook integration
- **PDF Download:** Automatic download on report generation
- **Preview:** Shows executive summary and statistics

---

## ğŸ”§ n8n Configuration Steps

### Step 1: Add Webhook Trigger

1. Open your workflow in n8n webapp
2. **Add a new Webhook node** (drag from node panel)
3. Place it **before Node 2 (Set Config)**
4. **Configure the Webhook node:**

```
HTTP Method: POST
Path: weekly-compliance-webhook
Response Code: 200
Response Mode: Last Node
Response Data: $json (default)
Authentication: None
```

5. **Connect:** Webhook â†’ Node 2 (Set Config)

### Step 2: Update Node 16 (Generate PDF)

**Replace ALL code in Node 16 with this:**

```javascript
// Return report data for web app (PDF generated by backend)
const data = $input.item.json;

return {
  json: {
    success: true,
    reportData: {
      executive_summary: data.executive_summary,
      areas: data.areas,
      all_stores: data.all_stores,
      config: data.config,
      report_date: data.report_date
    },
    timestamp: new Date().toISOString(),
    message: 'Report data ready for PDF generation'
  }
};
```

### Step 3: Verify Node Connections

Make sure the workflow flows like this:

```
Webhook Trigger
    â†“
Set Config (Node 2)
    â†“
Get OAuth Token (Node 3)
    â†“
... (all existing nodes)
    â†“
Parse AI Response (Node 15)
    â†“
Generate PDF (Node 16) â† LAST NODE (returns to webhook)
```

**Important:** Node 16 must be the LAST node because Response Mode is "Last Node"

### Step 4: Activate the Workflow

1. Click **"Active"** toggle in top right
2. The webhook URL will be displayed
3. It should be: `http://localhost:5678/webhook/weekly-compliance-webhook`

---

## ğŸš€ Testing the Integration

### Test 1: Check Backend Server

```bash
curl http://localhost:3001/api/health
```

**Expected Response:**
```json
{
  "status": "healthy",
  "timestamp": "2025-11-23T...",
  "service": "Weekly Report Automation API"
}
```

### Test 2: Check n8n Webhook

In n8n:
1. Click on the Webhook node
2. Click "Listen for Test Event"
3. Send a test request from terminal:

```bash
curl -X POST http://localhost:5678/webhook/weekly-compliance-webhook \
  -H "Content-Type: application/json" \
  -d '{"test": true}'
```

4. The workflow should execute
5. Check if Node 16 returns success JSON

### Test 3: Full Web App Test

1. **Open the web app:**
   ```bash
   open /Users/charlesjr/Claude\ Projects/Inogentive/web-ui/index.html
   ```

2. **Click "Sync & Analyze" button**

3. **Watch the progress:**
   - Calling n8n workflow...
   - Extracting data from Power BI
   - AI analyzing data
   - Generating PDF report...
   - Report generated successfully!

4. **Expected Result:**
   - PDF automatically downloads
   - Preview modal shows executive summary
   - Report appears in history

---

## ğŸ“Š Complete Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web App   â”‚ (User clicks "Sync & Analyze")
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP POST
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  n8n Workflow (localhost:5678)      â”‚
â”‚                                     â”‚
â”‚  1. Webhook Trigger                 â”‚
â”‚  2. Set Config                      â”‚
â”‚  3. Get OAuth Token                 â”‚
â”‚  4. Get Dataset Metadata            â”‚
â”‚  5. Parse Metadata                  â”‚
â”‚  6. Extract Budget Hours            â”‚
â”‚  7. Extract Worked Hours            â”‚
â”‚  8. Extract Clocking Data           â”‚
â”‚  9. Merge Store Data                â”‚
â”‚ 10. Calculate KPIs                  â”‚
â”‚ 11. Aggregate by Area               â”‚
â”‚ 12. Prepare AI Context              â”‚
â”‚ 13. Generate AI Narrative (GPT-4o)  â”‚
â”‚ 14. Parse AI Response               â”‚
â”‚ 15. Return JSON Data                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Returns JSON
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web App   â”‚ (Receives report data)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP POST to /api/generate-pdf
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend Server (localhost:3001)    â”‚
â”‚                                     â”‚
â”‚  - Receives reportData JSON         â”‚
â”‚  - Creates PDF using PDFKit         â”‚
â”‚  - Formats compliance report        â”‚
â”‚  - Returns PDF as binary stream     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Returns PDF
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web App   â”‚
â”‚             â”‚
â”‚  - Auto-downloads PDF               â”‚
â”‚  - Shows preview modal              â”‚
â”‚  - Adds to report history           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› Troubleshooting

### Issue: "n8n webhook error! status: 404"

**Cause:** Webhook path doesn't match or workflow not active

**Fix:**
1. Verify webhook path in n8n is: `weekly-compliance-webhook`
2. Ensure workflow is **Active** (toggle in top right)
3. Check n8n is running on port 5678

---

### Issue: "PDF generation error! status: 500"

**Cause:** Backend server error or missing data

**Fix:**
1. Check backend server logs
2. Verify Node 16 returns valid `reportData` object
3. Test backend directly:

```bash
curl -X POST http://localhost:3001/api/generate-pdf \
  -H "Content-Type: application/json" \
  -d '{
    "reportData": {
      "executive_summary": "Test summary",
      "areas": [],
      "all_stores": [],
      "report_date": "2025-11-23T12:00:00Z"
    }
  }' \
  --output test-report.pdf
```

---

### Issue: OpenAI API Error in Node 14

**Cause:** OpenAI API key not configured

**Fix:**
1. In n8n, go to **Credentials**
2. Add **OpenAI Credentials**
3. Enter your API key
4. Select credentials in Node 14

---

### Issue: Power BI Authentication Failed

**Cause:** OAuth token expired or invalid credentials

**Fix:**
1. Check Node 2 (Set Config) has correct:
   - `POWERBI_TENANT_ID`
   - `POWERBI_CLIENT_ID`
   - `POWERBI_CLIENT_SECRET`
2. Re-run from Node 3 (Get OAuth Token)

---

## ğŸ“ Configuration Summary

### n8n Webhook
- **URL:** `http://localhost:5678/webhook/weekly-compliance-webhook`
- **Method:** POST
- **Returns:** JSON with reportData

### Backend API
- **Base URL:** `http://localhost:3001`
- **PDF Endpoint:** POST `/api/generate-pdf`
- **Payload:** `{ "reportData": {...} }`
- **Returns:** PDF binary (application/pdf)

### Web App
- **File:** `/web-ui/index.html`
- **Config:** `app.js` lines 7-14
- **Webhook URL:** `CONFIG.N8N_SYNC_ANALYZE_WEBHOOK`
- **Backend URL:** `CONFIG.BACKEND_API_URL`

---

## âœ¨ Features

### âœ… Implemented
- [x] n8n workflow execution via webhook
- [x] Power BI data extraction
- [x] AI-powered executive summary (GPT-4o)
- [x] KPI calculation and exception flagging
- [x] Area-level aggregation
- [x] PDF generation with PDFKit
- [x] Automatic PDF download
- [x] Preview modal with statistics
- [x] Report history tracking

### â¸ï¸ Skipped (Per Requirements)
- [ ] Email delivery (skipped)
- [ ] Azure Blob Storage archival (skipped)
- [ ] Error email notifications (skipped)

---

## ğŸ¯ Next Steps

1. **Complete n8n configuration** (Steps 1-4 above)
2. **Test the webhook** (Test 2)
3. **Run full integration test** (Test 3)
4. **Verify PDF downloads correctly**
5. **Check executive summary accuracy**

---

## ğŸ“ Support

If you encounter issues:

1. **Check all services are running:**
   ```bash
   # Backend server
   lsof -i :3001

   # n8n
   lsof -i :5678
   ```

2. **View backend logs:**
   Backend will show requests and errors in the terminal

3. **Check n8n execution logs:**
   Click on any node â†’ "Executions" tab

4. **Browser console:**
   Open DevTools (F12) â†’ Console tab for web app errors

---

**Ready to test!** Follow Steps 1-4 in the n8n Configuration section, then run Test 3.
